<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ch·∫•m ƒêi·ªÉm TOEFL Primary - LIME Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .camera-container {
            position: relative;
            max-width: 640px;
            margin: 0 auto;
        }
        #video {
            width: 100%;
            border-radius: 12px;
        }
        #canvas {
            display: none;
        }
        .preview-image {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<!-- M√†n h√¨nh Setup API -->
<div id="setupScreen" class="min-h-screen p-4 flex items-center justify-center fade-in">
    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8">
        <div class="text-center mb-8">
            <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                 alt="LIME Logo" 
                 class="w-24 h-24 mx-auto mb-4 object-contain">
            <h1 class="text-3xl font-bold text-purple-700 mb-2">H·ªá Th·ªëng Ch·∫•m ƒêi·ªÉm TOEFL</h1>
            <p class="text-purple-600">Trung T√¢m Ti·∫øng Anh LIME - Hotline: 0976222792</p>
        </div>

        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-6">
            <div class="flex items-start gap-2">
                <svg class="w-6 h-6 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="text-yellow-800 text-sm">
                    <p class="font-bold mb-1">‚ö†Ô∏è C·∫ßn thi·∫øt l·∫≠p API Key l·∫ßn ƒë·∫ßu:</p>
                    <p>H·ªá th·ªëng s·ª≠ d·ª•ng Google Gemini AI ƒë·ªÉ ƒë·ªçc phi·∫øu tr·∫£ l·ªùi. B·∫°n c·∫ßn c√≥ API key t·ª´ Google AI Studio (MI·ªÑN PH√ç).</p>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-purple-800 font-semibold mb-2">
                     Google Gemini API Key *
    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 text-sm ml-2">(L·∫•y API key mi·ªÖn ph√≠ t·∫°i ƒë√¢y)</a>
</label>
<input type="password" id="apiKeyInput" 
    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none font-mono text-sm"
    placeholder="AIza...">
            </div>

            <div>
                <label class="block text-purple-800 font-semibold mb-2">Google Sheets URL *</label>
                <input type="text" id="sheetsUrlInput" 
                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none"
                    placeholder="https://script.google.com/macros/s/...">
            </div>
        </div>

        <button onclick="saveConfig()" 
            class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
            L∆∞u c·∫•u h√¨nh v√† B·∫Øt ƒë·∫ßu
        </button>

        <div class="mt-6 p-4 bg-purple-50 rounded-lg">
            <p class="text-sm text-purple-700">
                <strong>üí° L∆∞u √Ω:</strong> API key s·∫Ω ƒë∆∞·ª£c l∆∞u tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n (localStorage). 
                Kh√¥ng chia s·∫ª API key v·ªõi ng∆∞·ªùi kh√°c.
            </p>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh Nh·∫≠p th√¥ng tin -->
<div id="infoScreen" class="hidden min-h-screen p-4 fade-in">
    <div class="max-w-2xl mx-auto mt-8">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                     alt="LIME Logo" 
                     class="w-24 h-24 mx-auto mb-4 object-contain">
                <h1 class="text-3xl font-bold text-purple-700 mb-2">Ch·∫•m B√†i TOEFL Primary</h1>
                <p class="text-purple-600">Step 2 - Reading & Listening</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-purple-800 font-semibold mb-2">H·ªç v√† t√™n h·ªçc sinh *</label>
                    <input type="text" id="studentName" 
                        class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none"
                        placeholder="Nh·∫≠p h·ªç t√™n">
                </div>
                
                <div>
                    <label class="block text-purple-800 font-semibold mb-2">L·ªõp *</label>
                    <input type="text" id="studentClass" 
                        class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none"
                        placeholder="Nh·∫≠p l·ªõp">
                </div>
                
                <div>
                    <label class="block text-purple-800 font-semibold mb-2">S·ªë ƒëi·ªán tho·∫°i ph·ª• huynh *</label>
                    <input type="tel" id="parentPhone" 
                        class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none"
                        placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                </div>
            </div>

            <button onclick="startCapture()" 
                class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
                üì∏ Ch·ª•p Phi·∫øu Tr·∫£ L·ªùi
            </button>

            <button onclick="showSetupScreen()" 
                class="w-full mt-3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                ‚öôÔ∏è C√†i ƒë·∫∑t API
            </button>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh Camera -->
<div id="cameraScreen" class="hidden min-h-screen p-4 fade-in">
    <div class="max-w-4xl mx-auto mt-8">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold text-purple-700 mb-6 text-center">üì∏ Ch·ª•p Phi·∫øu Tr·∫£ L·ªùi</h2>

            <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-4 mb-6">
                <div class="flex items-start gap-2">
                    <svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-blue-800 text-sm">
                        <p class="font-bold mb-1">üí° H∆∞·ªõng d·∫´n ch·ª•p ·∫£nh t·ªët:</p>
                        <p>‚Ä¢ ƒê·∫∑t phi·∫øu tr√™n m·∫∑t ph·∫≥ng, √°nh s√°ng ƒë·ªÅu</p>
                        <p>‚Ä¢ Ch·ª•p th·∫≥ng g√≥c, kh√¥ng b·ªã nghi√™ng</p>
                        <p>‚Ä¢ ƒê·∫£m b·∫£o t·∫•t c·∫£ c√°c √¥ ƒë·ªÅu r√µ n√©t</p>
                        <p>‚Ä¢ C√°c √¥ t√¥ ph·∫£i ƒë·∫≠m, r√µ r√†ng</p>
                    </div>
                </div>
            </div>

            <div class="camera-container mb-6">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <div class="flex gap-4">
                <button onclick="capturePhoto()" 
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
                    üì∑ Ch·ª•p ·∫¢nh
                </button>
                <button onclick="backToInfo()" 
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-lg transition duration-300">
                    ‚Üê Quay L·∫°i
                </button>
            </div>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh Preview & Processing -->
<div id="previewScreen" class="hidden min-h-screen p-4 fade-in">
    <div class="max-w-4xl mx-auto mt-8">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold text-purple-700 mb-6 text-center">üîç X√°c Nh·∫≠n ·∫¢nh</h2>

            <div id="previewContainer" class="mb-6 text-center">
                <img id="previewImage" class="preview-image mx-auto" alt="Preview">
            </div>

            <div id="processingStatus" class="hidden mb-6">
                <div class="bg-purple-50 border-2 border-purple-300 rounded-xl p-6">
                    <div class="flex items-center justify-center gap-4 mb-4">
                        <div class="spinner"></div>
                        <p class="text-purple-700 font-bold text-lg">ƒêang x·ª≠ l√Ω...</p>
                    </div>
                    <p id="statusText" class="text-center text-purple-600"></p>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="processAnswerSheet()" id="processBtn"
                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
                    ‚úÖ X√°c Nh·∫≠n & Ch·∫•m ƒêi·ªÉm
                </button>
                <button onclick="retakePhoto()" id="retakeBtn"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-lg transition duration-300">
                    üîÑ Ch·ª•p L·∫°i
                </button>
            </div>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh K·∫øt qu·∫£ -->
<div id="resultScreen" class="hidden min-h-screen p-4 fade-in">
    <div class="max-w-5xl mx-auto mt-8">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                     alt="LIME Logo" 
                     class="w-24 h-24 mx-auto mb-4 object-contain">
                <h1 class="text-3xl font-bold text-purple-700 mb-2">üìä K·∫øt Qu·∫£ Ch·∫•m ƒêi·ªÉm</h1>
            </div>

            <div id="resultContent" class="space-y-6">
                <!-- Results will be inserted here -->
            </div>

            <button onclick="resetSystem()" 
                class="w-full mt-8 bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
                üîÑ Ch·∫•m B√†i M·ªõi
            </button>
        </div>
    </div>
</div>

<script>
// *** C·∫§U H√åNH C·ªê ƒê·ªäNH - NH·∫¨P TR·ª∞C TI·∫æP V√ÄO ƒê√ÇY ***
const FIXED_CONFIG = {
    apiKey: 'AIzaSyBLOjZc6aFU-SmCCU7kBUrZZvPgFSLhe6g',  // ‚Üê D√ÅN API KEY V√ÄO ƒê√ÇY
    sheetsUrl: 'https://script.google.com/macros/s/AKfycbyVJx8lwWGF4612xewVaIZZD8elx68iQmuwLIWQUelFyRMHfzvqoa5sS39PRbk-kfT5Pw/exec'  // ‚Üê D√ÅN GOOGLE SHEETS URL V√ÄO ƒê√ÇY
};

// ƒê√ÅP √ÅN CHU·∫®N
const CORRECT_ANSWERS = {
    reading: {
        2: 'C', 3: 'B', 4: 'B', 5: 'A', 6: 'B', 7: 'C',
        8: 'B', 9: 'C', 10: 'B', 11: 'C', 12: 'B', 13: 'A',
        14: 'B', 15: 'A', 16: 'C', 17: 'B', 18: 'C',
        19: 'B', 20: 'B', 21: 'B', 22: 'B', 23: 'B',
        24: 'C', 25: 'A', 26: 'B', 27: 'B', 28: 'C',
        29: 'B', 30: 'C', 31: 'B', 32: 'B', 33: 'C',
        34: 'B', 35: 'B', 36: 'B', 37: 'B'
    },
    listening: {
        1: 'B', 2: 'A', 3: 'B', 4: 'A', 5: 'B', 6: 'B', 7: 'A',
        8: 'C', 9: 'C', 10: 'B', 11: 'A', 12: 'B', 13: 'B', 14: 'B',
        15: 'B', 16: 'A', 17: 'A', 18: 'B', 19: 'B', 20: 'A', 21: 'A',
        22: 'C', 23: 'B', 24: 'B', 25: 'A', 26: 'C', 27: 'A', 28: 'A',
        29: 'C', 30: 'C', 31: 'B', 32: 'C', 33: 'A', 34: 'C', 35: 'B',
        36: 'B', 37: 'A', 38: 'B', 39: 'C'
    }
};

// PH√ÇN LO·∫†I K·ª∏ NƒÇNG
const SKILL_CATEGORIES = {
    reading: {
        vocabulary: { questions: [2, 3, 4, 5, 6, 7], name: 'T·ª´ v·ª±ng', level: 'A2-B1' },
        mainIdea: { questions: [10, 11, 30, 34, 37], name: '√ù ch√≠nh', level: 'A2-B1' },
        details: { questions: [8, 9, 12, 13, 14, 16, 23, 25, 27, 28, 31, 32], name: 'Chi ti·∫øt', level: 'A2' },
        inference: { questions: [15, 22, 26, 29, 33, 35, 36], name: 'Suy lu·∫≠n', level: 'B1' },
        sequence: { questions: [19, 20, 21, 24], name: 'Tr√¨nh t·ª±', level: 'A2' },
        purpose: { questions: [17, 18], name: 'M·ª•c ƒë√≠ch', level: 'A2-B1' }
    },
    listening: {
        basicComprehension: { questions: [1, 2, 3, 4, 5, 6, 7, 23, 27], name: 'Hi·ªÉu c∆° b·∫£n', level: 'A1-A2' },
        mainIdea: { questions: [22, 30, 33, 36], name: '√ù ch√≠nh', level: 'A2-B1' },
        details: { questions: [8, 9, 10, 11, 12, 14, 24, 25, 28, 31, 32, 37, 38], name: 'Chi ti·∫øt', level: 'A2' },
        inference: { questions: [13, 18, 19, 29, 34, 35, 39], name: 'Suy lu·∫≠n', level: 'B1' },
        purpose: { questions: [15, 16, 17, 20, 21, 26], name: 'M·ª•c ƒë√≠ch', level: 'A2-B1' }
    }
};

let config = {
    apiKey: FIXED_CONFIG.apiKey,
    sheetsUrl: FIXED_CONFIG.sheetsUrl
};
let studentInfo = {};
let capturedImageData = null;
let stream = null;

// Load config from localStorage or use fixed config
function loadConfig() {
    // Ki·ªÉm tra n·∫øu ƒë√£ c√≥ c·∫•u h√¨nh c·ªë ƒë·ªãnh
    if (FIXED_CONFIG.apiKey !== 'AIzaPASTE_YOUR_GEMINI_KEY_HERE' &&  
        FIXED_CONFIG.sheetsUrl !== 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec') {
        // D√πng config c·ªë ƒë·ªãnh t·ª´ code
        config = {
            apiKey: FIXED_CONFIG.apiKey,
            sheetsUrl: FIXED_CONFIG.sheetsUrl
        };
        // B·ªè qua m√†n h√¨nh setup, v√†o th·∫≥ng m√†n h√¨nh nh·∫≠p th√¥ng tin
        document.getElementById('setupScreen').classList.add('hidden');
        document.getElementById('infoScreen').classList.remove('hidden');
        return;
    }
    
    // N·∫øu ch∆∞a c√≥ config c·ªë ƒë·ªãnh, d√πng localStorage
    const saved = localStorage.getItem('toefl_config');
    if (saved) {
        config = JSON.parse(saved);
        if (config.apiKey && config.sheetsUrl) {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('infoScreen').classList.remove('hidden');
        }
    }
}

function saveConfig() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const sheetsUrl = document.getElementById('sheetsUrlInput').value.trim();
    
    if (!apiKey || !sheetsUrl) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
    }
    
    config = { apiKey, sheetsUrl };
    localStorage.setItem('toefl_config', JSON.stringify(config));
    
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('infoScreen').classList.remove('hidden');
}

function showSetupScreen() {
    document.getElementById('infoScreen').classList.add('hidden');
    document.getElementById('setupScreen').classList.remove('hidden');
    
    document.getElementById('apiKeyInput').value = config.apiKey || '';
    document.getElementById('sheetsUrlInput').value = config.sheetsUrl || '';
}

function startCapture() {
    const name = document.getElementById('studentName').value.trim();
    const classVal = document.getElementById('studentClass').value.trim();
    const phone = document.getElementById('parentPhone').value.trim();
    
    if (!name || !classVal || !phone) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin h·ªçc sinh!');
        return;
    }
    
    studentInfo = { name, class: classVal, parentPhone: phone };
    
    document.getElementById('infoScreen').classList.add('hidden');
    document.getElementById('cameraScreen').classList.remove('hidden');
    
    startCamera();
}

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 4096 },
                height: { ideal: 2160 },
                aspectRatio: 16/9
            } 
        });
        document.getElementById('video').srcObject = stream;
    } catch (error) {
        alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + error.message);
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
}

function capturePhoto() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    capturedImageData = canvas.toDataURL('image/jpeg', 1.0);
    
    stopCamera();
    
    document.getElementById('cameraScreen').classList.add('hidden');
    document.getElementById('previewScreen').classList.remove('hidden');
    document.getElementById('previewImage').src = capturedImageData;
}

function backToInfo() {
    stopCamera();
    document.getElementById('cameraScreen').classList.add('hidden');
    document.getElementById('infoScreen').classList.remove('hidden');
}

function retakePhoto() {
    document.getElementById('previewScreen').classList.add('hidden');
    document.getElementById('cameraScreen').classList.remove('hidden');
    startCamera();
}

async function processAnswerSheet() {
    document.getElementById('processBtn').disabled = true;
    document.getElementById('retakeBtn').disabled = true;
    document.getElementById('processingStatus').classList.remove('hidden');
    
    updateStatus('ƒêang g·ª≠i ·∫£nh ƒë·∫øn AI...');
    
    try {
        // Convert base64 to proper format
        const base64Data = capturedImageData.split(',')[1];
        
        updateStatus('AI ƒëang ph√¢n t√≠ch phi·∫øu tr·∫£ l·ªùi...');
        
        // Call Gemini API
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${config.apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        {
                            inline_data: {
                                mime_type: 'image/jpeg',
                                data: base64Data
                            }
                        },
                        {
                            text: `ƒê√¢y l√† phi·∫øu tr·∫£ l·ªùi TOEFL Primary Step 2.

Phi·∫øu c√≥ 2 ph·∫ßn:
- READING: c√¢u 1-39 (c·ªôt b√™n tr√°i, header m√†u xanh l√°)
- LISTENING: c√¢u 1-41 (c·ªôt b√™n ph·∫£i, header m√†u h·ªìng)

Nhi·ªám v·ª•: ƒê·ªçc c√°c √¥ tr√≤n ƒë√£ ƒë∆∞·ª£c t√¥ ƒëen/ƒë·∫≠m v√† tr·∫£ v·ªÅ JSON v·ªõi format:

{
  "reading": {
    "1": "A",
    "2": "B",
    ...
  },
  "listening": {
    "1": "C",
    "2": "A",
    ...
  }
}

CH·ªà TR·∫¢ V·ªÄ JSON, KH√îNG GI·∫¢I TH√çCH G√å TH√äM. N·∫øu c√¢u n√†o kh√¥ng t√¥ ho·∫∑c kh√¥ng r√µ th√¨ b·ªè qua c√¢u ƒë√≥.`
                        }
                    ]
                }]
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error('API request failed: ' + (errorData.error?.message || response.status));
        }
        
        const data = await response.json();
        const aiResponse = data.candidates[0].content.parts[0].text;
        
        updateStatus('ƒêang x·ª≠ l√Ω k·∫øt qu·∫£...');
        
        // Parse JSON from AI response
        const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
            throw new Error('Kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c phi·∫øu tr·∫£ l·ªùi. Vui l√≤ng ch·ª•p l·∫°i ·∫£nh r√µ h∆°n.');
        }
        
        const studentAnswers = JSON.parse(jsonMatch[0]);
        
        // Calculate scores
        const results = calculateScores(studentAnswers);
        
        updateStatus('ƒêang g·ª≠i k·∫øt qu·∫£ l√™n Google Sheets...');
        
        // Send to Google Sheets
        await sendToGoogleSheets(results);
        
        // Show results
        displayResults(results);
        
    } catch (error) {
        alert('L·ªói: ' + error.message);
        document.getElementById('processBtn').disabled = false;
        document.getElementById('retakeBtn').disabled = false;
        document.getElementById('processingStatus').classList.add('hidden');
    }
}

function updateStatus(text) {
    document.getElementById('statusText').textContent = text;
}

function calculateScores(studentAnswers) {
    const results = {
        student: studentInfo,
        timestamp: new Date().toLocaleString('vi-VN'),
        reading: analyzeSection('reading', studentAnswers.reading || {}),
        listening: analyzeSection('listening', studentAnswers.listening || {})
    };
    
    return results;
}

function analyzeSection(section, answers) {
    const correctAnswers = CORRECT_ANSWERS[section];
    const skills = SKILL_CATEGORIES[section];
    
    let correctCount = 0;
    let totalQuestions = Object.keys(correctAnswers).length;
    const wrongQuestions = [];
    
    // Calculate total score
    for (const [qNum, correctAns] of Object.entries(correctAnswers)) {
        if (answers[qNum] === correctAns) {
            correctCount++;
        } else if (answers[qNum]) {
            wrongQuestions.push(qNum);
        }
    }
    
    const totalScore = Math.round((correctCount / totalQuestions) * 100);
    
    // Calculate skill scores
    const skillScores = {};
    for (const [skillName, skillData] of Object.entries(skills)) {
        let skillCorrect = 0;
        skillData.questions.forEach(qNum => {
            if (answers[qNum] === correctAnswers[qNum]) {
                skillCorrect++;
            }
        });
        skillScores[skillName] = {
            correct: skillCorrect,
            total: skillData.questions.length,
            percentage: Math.round((skillCorrect / skillData.questions.length) * 100),
            name: skillData.name,
            level: skillData.level
        };
    }
    
    // Estimate CEFR level
    const cefrLevel = estimateCEFR(totalScore, skillScores, section);
    
    return {
        answers,
        correctCount,
        totalQuestions,
        totalScore,
        wrongQuestions,
        skillScores,
        cefrLevel,
        analysis: generateAnalysis(totalScore, skillScores, cefrLevel, section)
    };
}

function estimateCEFR(score, skills, section) {
    if (section === 'reading') {
        const vocab = skills.vocabulary.percentage;
        const inference = skills.inference.percentage;
        
        if (score >= 90 && vocab >= 85 && inference >= 85) return 'B1 - Cu·ªëi';
        if (score >= 80 && vocab >= 75) return 'B1 - Gi·ªØa';
        if (score >= 70 && inference >= 60) return 'B1 - ƒê·∫ßu';
        if (score >= 60) return 'A2 - Cu·ªëi';
        if (score >= 50) return 'A2 - Gi·ªØa';
        if (score >= 40) return 'A2 - ƒê·∫ßu';
        return 'A1';
    } else {
        const basic = skills.basicComprehension.percentage;
        const inference = skills.inference.percentage;
        
        if (score >= 90 && basic >= 85 && inference >= 85) return 'B1 - Cu·ªëi';
        if (score >= 80 && inference >= 70) return 'B1 - Gi·ªØa';
        if (score >= 70 && inference >= 60) return 'B1 - ƒê·∫ßu';
        if (score >= 60) return 'A2 - Cu·ªëi';
        if (score >= 50) return 'A2 - Gi·ªØa';
        if (score >= 40) return 'A2 - ƒê·∫ßu';
        return 'A1';
    }
}

function generateAnalysis(score, skills, cefr, section) {
    let analysis = `ƒêi·ªÉm: ${score}% (${cefr}). `;
    
    const strengths = [];
    const weaknesses = [];
    
    for (const [skillName, skillData] of Object.entries(skills)) {
        if (skillData.percentage >= 75) {
            strengths.push(`${skillData.name} (${skillData.percentage}%)`);
        } else if (skillData.percentage < 60) {
            weaknesses.push(`${skillData.name} (${skillData.percentage}%)`);
        }
    }
    
    if (strengths.length > 0) {
        analysis += `ƒêi·ªÉm m·∫°nh: ${strengths.join(', ')}. `;
    }
    
    if (weaknesses.length > 0) {
        analysis += `C·∫ßn c·∫£i thi·ªán: ${weaknesses.join(', ')}. `;
    }
    
    return analysis;
}

async function sendToGoogleSheets(results) {
    const data = {
        timestamp: results.timestamp,
        name: results.student.name,
        class: results.student.class,
        parentPhone: results.student.parentPhone,
        
        // Reading data
        readingScore: results.reading.totalScore,
        readingCorrect: results.reading.correctCount,
        readingTotal: results.reading.totalQuestions,
        readingCEFR: results.reading.cefrLevel,
        readingWrongQuestions: results.reading.wrongQuestions.join(', ') || 'Kh√¥ng c√≥',
        readingAnalysis: results.reading.analysis,
        readingVocabulary: results.reading.skillScores.vocabulary?.percentage || 0,
        readingMainIdea: results.reading.skillScores.mainIdea?.percentage || 0,
        readingDetails: results.reading.skillScores.details?.percentage || 0,
        readingInference: results.reading.skillScores.inference?.percentage || 0,
        readingSequence: results.reading.skillScores.sequence?.percentage || 0,
        readingPurpose: results.reading.skillScores.purpose?.percentage || 0,
        
        // Listening data
        listeningScore: results.listening.totalScore,
        listeningCorrect: results.listening.correctCount,
        listeningTotal: results.listening.totalQuestions,
        listeningCEFR: results.listening.cefrLevel,
        listeningWrongQuestions: results.listening.wrongQuestions.join(', ') || 'Kh√¥ng c√≥',
        listeningAnalysis: results.listening.analysis,
        listeningBasic: results.listening.skillScores.basicComprehension?.percentage || 0,
        listeningMainIdea: results.listening.skillScores.mainIdea?.percentage || 0,
        listeningDetails: results.listening.skillScores.details?.percentage || 0,
        listeningInference: results.listening.skillScores.inference?.percentage || 0,
        listeningPurpose: results.listening.skillScores.purpose?.percentage || 0,
        
        // Overall
        overallScore: Math.round((results.reading.totalScore + results.listening.totalScore) / 2),
        
        // Raw answers
        readingAnswers: JSON.stringify(results.reading.answers),
        listeningAnswers: JSON.stringify(results.listening.answers)
    };
    
    try {
        await fetch(config.sheetsUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
    } catch (error) {
        console.error('L·ªói khi g·ª≠i Google Sheets:', error);
    }
}

function displayResults(results) {
    document.getElementById('previewScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');
    
    const html = `
        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 mb-6 border-2 border-purple-200">
            <h2 class="text-2xl font-bold text-purple-700 mb-4">üìã Th√¥ng Tin H·ªçc Sinh</h2>
            <div class="grid grid-cols-2 gap-4 text-lg">
                <div><strong>H·ªç t√™n:</strong> ${results.student.name}</div>
                <div><strong>L·ªõp:</strong> ${results.student.class}</div>
                <div><strong>SƒêT ph·ª• huynh:</strong> ${results.student.parentPhone}</div>
                <div><strong>Th·ªùi gian:</strong> ${results.timestamp}</div>
            </div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- READING RESULTS -->
            <div class="bg-green-50 rounded-xl p-6 border-2 border-green-300">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-green-600 text-white rounded-full flex items-center justify-center text-2xl font-bold">
                        R
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-green-800">READING</h3>
                        <p class="text-green-600 text-sm">K·ªπ nƒÉng ƒë·ªçc</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4 mb-4">
                    <div class="text-center">
                        <div class="text-5xl font-bold text-green-600 mb-2">${results.reading.totalScore}%</div>
                        <div class="text-lg font-semibold text-green-700">${results.reading.cefrLevel}</div>
                        <div class="text-sm text-gray-600 mt-2">
                            ${results.reading.correctCount}/${results.reading.totalQuestions} c√¢u ƒë√∫ng
                        </div>
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    ${Object.entries(results.reading.skillScores).map(([key, skill]) => `
                        <div class="bg-white rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-semibold text-gray-700">${skill.name}</span>
                                <span class="text-sm font-bold ${skill.percentage >= 75 ? 'text-green-600' : skill.percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${skill.percentage}%
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full ${skill.percentage >= 75 ? 'bg-green-500' : skill.percentage >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                     style="width: ${skill.percentage}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${skill.correct}/${skill.total} c√¢u ‚Ä¢ Level ${skill.level}</div>
                        </div>
                    `).join('')}
                </div>
                
                ${results.reading.wrongQuestions.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <p class="text-sm font-semibold text-red-700 mb-1">‚ùå C√¢u sai:</p>
                        <p class="text-sm text-red-600">${results.reading.wrongQuestions.join(', ')}</p>
                    </div>
                ` : ''}
            </div>
            
            <!-- LISTENING RESULTS -->
            <div class="bg-blue-50 rounded-xl p-6 border-2 border-blue-300">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl font-bold">
                        L
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-blue-800">LISTENING</h3>
                        <p class="text-blue-600 text-sm">K·ªπ nƒÉng nghe</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4 mb-4">
                    <div class="text-center">
                        <div class="text-5xl font-bold text-blue-600 mb-2">${results.listening.totalScore}%</div>
                        <div class="text-lg font-semibold text-blue-700">${results.listening.cefrLevel}</div>
                        <div class="text-sm text-gray-600 mt-2">
                            ${results.listening.correctCount}/${results.listening.totalQuestions} c√¢u ƒë√∫ng
                        </div>
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    ${Object.entries(results.listening.skillScores).map(([key, skill]) => `
                        <div class="bg-white rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-semibold text-gray-700">${skill.name}</span>
                                <span class="text-sm font-bold ${skill.percentage >= 75 ? 'text-green-600' : skill.percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${skill.percentage}%
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full ${skill.percentage >= 75 ? 'bg-green-500' : skill.percentage >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                     style="width: ${skill.percentage}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${skill.correct}/${skill.total} c√¢u ‚Ä¢ Level ${skill.level}</div>
                        </div>
                    `).join('')}
                </div>
                
                ${results.listening.wrongQuestions.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <p class="text-sm font-semibold text-red-700 mb-1">‚ùå C√¢u sai:</p>
                        <p class="text-sm text-red-600">${results.listening.wrongQuestions.join(', ')}</p>
                    </div>
                ` : ''}
            </div>
        </div>
        
        <!-- OVERALL ANALYSIS -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border-2 border-purple-300">
            <h3 class="text-xl font-bold text-purple-700 mb-4">üìä Ph√¢n T√≠ch T·ªïng Quan</h3>
            
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div class="bg-white rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">ƒêi·ªÉm trung b√¨nh</p>
                    <p class="text-3xl font-bold text-purple-600">
                        ${Math.round((results.reading.totalScore + results.listening.totalScore) / 2)}%
                    </p>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">CEFR Level d·ª± ki·∫øn</p>
                    <p class="text-2xl font-bold text-purple-600">
                        ${getBestCEFR(results.reading.cefrLevel, results.listening.cefrLevel)}
                    </p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 space-y-3">
                <div>
                    <p class="font-semibold text-green-700 mb-2">‚úÖ Reading Analysis:</p>
                    <p class="text-sm text-gray-700">${results.reading.analysis}</p>
                </div>
                <div>
                    <p class="font-semibold text-blue-700 mb-2">‚úÖ Listening Analysis:</p>
                    <p class="text-sm text-gray-700">${results.listening.analysis}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6 mt-6">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="font-bold text-yellow-800 mb-2">üìû Li√™n h·ªá ph·ª• huynh:</h3>
                    <p class="text-yellow-700 text-sm">
                        K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng. Gi√°o vi√™n s·∫Ω li√™n h·ªá ph·ª• huynh qua s·ªë 
                        <strong>${results.student.parentPhone}</strong> ƒë·ªÉ t∆∞ v·∫•n chi ti·∫øt v·ªÅ k·∫øt qu·∫£ v√† l·ªô tr√¨nh h·ªçc t·∫≠p.
                    </p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('resultContent').innerHTML = html;
}

function getBestCEFR(reading, listening) {
    const levels = ['A1', 'A2 - ƒê·∫ßu', 'A2 - Gi·ªØa', 'A2 - Cu·ªëi', 'B1 - ƒê·∫ßu', 'B1 - Gi·ªØa', 'B1 - Cu·ªëi'];
    const r = levels.findIndex(l => reading.includes(l.split(' ')[0]));
    const l = levels.findIndex(l => listening.includes(l.split(' ')[0]));
    return levels[Math.floor((r + l) / 2)] || 'A2';
}

function resetSystem() {
    document.getElementById('resultScreen').classList.add('hidden');
    document.getElementById('infoScreen').classList.remove('hidden');
    
    document.getElementById('studentName').value = '';
    document.getElementById('studentClass').value = '';
    document.getElementById('parentPhone').value = '';
    
    capturedImageData = null;
    studentInfo = {};
}

loadConfig();
</script>

</body>
</html>