<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ch·∫•m ƒêi·ªÉm TOEFL Primary - LIME Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .camera-container {
            position: relative;
            max-width: 640px;
            margin: 0 auto;
        }
        #video {
            width: 100%;
            border-radius: 12px;
        }
        #canvas {
            display: none;
        }
        .preview-image {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<!-- M√†n h√¨nh Setup API -->
<div id="setupScreen" class="min-h-screen p-4 flex items-center justify-center fade-in">
    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8">
        <div class="text-center mb-8">
            <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                 alt="LIME Logo" 
                 class="w-24 h-24 mx-auto mb-4 object-contain">
            <h1 class="text-3xl font-bold text-purple-700 mb-2">H·ªá Th·ªëng Ch·∫•m ƒêi·ªÉm TOEFL</h1>
            <p class="text-purple-600">Trung T√¢m Ti·∫øng Anh LIME - Hotline: 0976222792</p>
        </div>

        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-6">
            <div class="flex items-start gap-2">
                <svg class="w-6 h-6 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="text-yellow-800 text-sm">
                    <p class="font-bold mb-1">‚ö†Ô∏è C·∫ßn thi·∫øt l·∫≠p API Key l·∫ßn ƒë·∫ßu:</p>
                    <p>H·ªá th·ªëng s·ª≠ d·ª•ng Google Gemini AI ƒë·ªÉ ƒë·ªçc phi·∫øu tr·∫£ l·ªùi. B·∫°n c·∫ßn c√≥ API key t·ª´ Google AI Studio (MI·ªÑN PH√ç).</p>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-purple-800 font-semibold mb-2">
                    üîë Google Gemini API Key *
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 text-sm ml-2">(L·∫•y API key mi·ªÖn ph√≠ t·∫°i ƒë√¢y)</a>
                </label>
                <input type="password" id="apiKeyInput" 
                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none font-mono text-sm"
                    placeholder="AIza...">
            </div>

            <div>
                <label class="block text-purple-800 font-semibold mb-2">Google Sheets URL *</label>
                <input type="text" id="sheetsUrlInput" 
                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none"
                    placeholder="https://script.google.com/macros/s/...">
            </div>
        </div>

        <button onclick="saveConfig()" 
            class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
            L∆∞u c·∫•u h√¨nh v√† B·∫Øt ƒë·∫ßu
        </button>

        <div class="mt-6 p-4 bg-purple-50 rounded-lg">
            <p class="text-sm text-purple-700">
                <strong>üí° L∆∞u √Ω:</strong> API key s·∫Ω ƒë∆∞·ª£c l∆∞u tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n (localStorage). 
                Kh√¥ng chia s·∫ª API key v·ªõi ng∆∞·ªùi kh√°c.
            </p>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh Nh·∫≠p th√¥ng tin -->
<div id="infoScreen" class="hidden min-h-screen p-4 fade-in">
    <div class="max-w-2xl mx-auto mt-8">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                     alt="LIME Logo" 
                     class="w-24 h-24 mx-auto mb-4 object-contain">
                <h1 class="text-3xl font-bold text-purple-700 mb-2">Ch·∫•m B√†i TOEFL Primary</h1>
                <p class="text-purple-600">Step 2 - Reading & Listening</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-purple-800 font-semibold mb-2">H·ªç v√† t√™n h·ªçc sinh *</label>
                    <input type="text" id="studentName" 
                        class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none"
                        placeholder="Nh·∫≠p h·ªç t√™n">
                </div>
                
                <div>
                    <label class="block text-purple-800 font-semibold mb-2">L·ªõp *</label>
                    <input type="text" id="studentClass" 
                        class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none"
                        placeholder="Nh·∫≠p l·ªõp">
                </div>
                
                <div>
                    <label class="block text-purple-800 font-semibold mb-2">S·ªë ƒëi·ªán tho·∫°i ph·ª• huynh *</label>
                    <input type="tel" id="parentPhone" 
                        class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none"
                        placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                </div>
            </div>

            <button onclick="startCapture()" 
                class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
                üì∏ Ch·ª•p Phi·∫øu Tr·∫£ L·ªùi
            </button>

            <button onclick="showSetupScreen()" 
                class="w-full mt-3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                ‚öôÔ∏è C√†i ƒë·∫∑t API
            </button>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh Camera -->
<div id="cameraScreen" class="hidden min-h-screen p-4 fade-in">
    <div class="max-w-4xl mx-auto mt-8">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold text-purple-700 mb-6 text-center">üì∏ Ch·ª•p Phi·∫øu Tr·∫£ L·ªùi</h2>

            <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-4 mb-6">
                <div class="flex items-start gap-2">
                    <svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-blue-800 text-sm">
                        <p class="font-bold mb-1">üí° H∆∞·ªõng d·∫´n ch·ª•p ·∫£nh t·ªët:</p>
                        <p>‚Ä¢ ƒê·∫∑t phi·∫øu tr√™n m·∫∑t ph·∫≥ng, √°nh s√°ng ƒë·ªÅu</p>
                        <p>‚Ä¢ Ch·ª•p th·∫≥ng g√≥c, kh√¥ng b·ªã nghi√™ng</p>
                        <p>‚Ä¢ ƒê·∫£m b·∫£o t·∫•t c·∫£ c√°c √¥ ƒë·ªÅu r√µ n√©t</p>
                        <p>‚Ä¢ C√°c √¥ t√¥ ph·∫£i ƒë·∫≠m, r√µ r√†ng</p>
                    </div>
                </div>
            </div>

            <div class="camera-container mb-6">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <div class="flex gap-4">
                <button onclick="capturePhoto()" 
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
                    üì∑ Ch·ª•p ·∫¢nh
                </button>
                <button onclick="backToInfo()" 
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-lg transition duration-300">
                    ‚Üê Quay L·∫°i
                </button>
            </div>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh Preview & Processing -->
<div id="previewScreen" class="hidden min-h-screen p-4 fade-in">
    <div class="max-w-4xl mx-auto mt-8">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold text-purple-700 mb-6 text-center">üîç X√°c Nh·∫≠n ·∫¢nh</h2>

            <div id="previewContainer" class="mb-6 text-center">
                <img id="previewImage" class="preview-image mx-auto" alt="Preview">
            </div>

            <div id="processingStatus" class="hidden mb-6">
                <div class="bg-purple-50 border-2 border-purple-300 rounded-xl p-6">
                    <div class="flex items-center justify-center gap-4 mb-4">
                        <div class="spinner"></div>
                        <p class="text-purple-700 font-bold text-lg">ƒêang x·ª≠ l√Ω...</p>
                    </div>
                    <p id="statusText" class="text-center text-purple-600"></p>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="processAnswerSheet()" id="processBtn"
                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
                    ‚úÖ X√°c Nh·∫≠n & Ch·∫•m ƒêi·ªÉm
                </button>
                <button onclick="retakePhoto()" id="retakeBtn"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-lg transition duration-300">
                    üîÑ Ch·ª•p L·∫°i
                </button>
            </div>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh K·∫øt qu·∫£ -->
<div id="resultScreen" class="hidden min-h-screen p-4 fade-in">
    <div class="max-w-5xl mx-auto mt-8">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                     alt="LIME Logo" 
                     class="w-24 h-24 mx-auto mb-4 object-contain">
                <h1 class="text-3xl font-bold text-purple-700 mb-2">üìä K·∫øt Qu·∫£ Ch·∫•m ƒêi·ªÉm</h1>
            </div>

            <div id="resultContent" class="space-y-6">
                <!-- Results will be inserted here -->
            </div>

            <button onclick="resetSystem()" 
                class="w-full mt-8 bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
                üîÑ Ch·∫•m B√†i M·ªõi
            </button>
        </div>
    </div>
</div>

<script>
// *** C·∫§U H√åNH C·ªê ƒê·ªäNH - NH·∫¨P TR·ª∞C TI·∫æP V√ÄO ƒê√ÇY ***
const FIXED_CONFIG = {
    apiKey: 'AIzaSyBLOjZc6aFU-SmCCU7kBUrZZvPgFSLhe6g',
    sheetsUrl: 'https://script.google.com/macros/s/AKfycbyVJx8lwWGF4612xewVaIZZD8elx68iQmuwLIWQUelFyRMHfzvqoa5sS39PRbk-kfT5Pw/exec'
};

// ƒê√ÅP √ÅN CHU·∫®N
const CORRECT_ANSWERS = {
    reading: {
        2: 'C', 3: 'B', 4: 'B', 5: 'A', 6: 'B', 7: 'C',
        8: 'B', 9: 'C', 10: 'B', 11: 'C', 12: 'B', 13: 'A',
        14: 'B', 15: 'A', 16: 'C', 17: 'B', 18: 'C',
        19: 'B', 20: 'B', 21: 'B', 22: 'B', 23: 'B',
        24: 'C', 25: 'A', 26: 'B', 27: 'B', 28: 'C',
        29: 'B', 30: 'C', 31: 'B', 32: 'B', 33: 'C',
        34: 'B', 35: 'B', 36: 'B', 37: 'B'
    },
    listening: {
        1: 'B', 2: 'A', 3: 'B', 4: 'A', 5: 'B', 6: 'B', 7: 'A',
        8: 'C', 9: 'C', 10: 'B', 11: 'A', 12: 'B', 13: 'B', 14: 'B',
        15: 'B', 16: 'A', 17: 'A', 18: 'B', 19: 'B', 20: 'A', 21: 'A',
        22: 'C', 23: 'B', 24: 'B', 25: 'A', 26: 'C', 27: 'A', 28: 'A',
        29: 'C', 30: 'C', 31: 'B', 32: 'C', 33: 'A', 34: 'C', 35: 'B',
        36: 'B', 37: 'A', 38: 'B', 39: 'C'
    }
};

// PH√ÇN LO·∫†I K·ª∏ NƒÇNG
const SKILL_CATEGORIES = {
    reading: {
        vocabulary: { questions: [2, 3, 4, 5, 6, 7], name: 'T·ª´ v·ª±ng', level: 'A2-B1' },
        mainIdea: { questions: [10, 11, 30, 34, 37], name: '√ù ch√≠nh', level: 'A2-B1' },
        details: { questions: [8, 9, 12, 13, 14, 16, 23, 25, 27, 28, 31, 32], name: 'Chi ti·∫øt', level: 'A2' },
        inference: { questions: [15, 22, 26, 29, 33, 35, 36], name: 'Suy lu·∫≠n', level: 'B1' },
        sequence: { questions: [19, 20, 21, 24], name: 'Tr√¨nh t·ª±', level: 'A2' },
        purpose: { questions: [17, 18], name: 'M·ª•c ƒë√≠ch', level: 'A2-B1' }
    },
    listening: {
        basicComprehension: { questions: [1, 2, 3, 4, 5, 6, 7, 23, 27], name: 'Hi·ªÉu c∆° b·∫£n', level: 'A1-A2' },
        mainIdea: { questions: [22, 30, 33, 36], name: '√ù ch√≠nh', level: 'A2-B1' },
        details: { questions: [8, 9, 10, 11, 12, 14, 24, 25, 28, 31, 32, 37, 38], name: 'Chi ti·∫øt', level: 'A2' },
        inference: { questions: [13, 18, 19, 29, 34, 35, 39], name: 'Suy lu·∫≠n', level: 'B1' },
        purpose: { questions: [15, 16, 17, 20, 21, 26], name: 'M·ª•c ƒë√≠ch', level: 'A2-B1' }
    }
};

let config = {
    apiKey: FIXED_CONFIG.apiKey,
    sheetsUrl: FIXED_CONFIG.sheetsUrl
};
let studentInfo = {};
let capturedImageData = null;
let stream = null;

function loadConfig() {
    if (FIXED_CONFIG.apiKey !== 'AIzaPASTE_YOUR_GEMINI_KEY_HERE' &&  
        FIXED_CONFIG.sheetsUrl !== 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec') {
        config = {
            apiKey: FIXED_CONFIG.apiKey,
            sheetsUrl: FIXED_CONFIG.sheetsUrl
        };
        document.getElementById('setupScreen').classList.add('hidden');
        document.getElementById('infoScreen').classList.remove('hidden');
        return;
    }
    
    const saved = localStorage.getItem('toefl_config');
    if (saved) {
        config = JSON.parse(saved);
        if (config.apiKey && config.sheetsUrl) {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('infoScreen').classList.remove('hidden');
        }
    }
}

function saveConfig() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const sheetsUrl = document.getElementById('sheetsUrlInput').value.trim();
    
    if (!apiKey || !sheetsUrl) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
    }
    
    config = { apiKey, sheetsUrl };
    localStorage.setItem('toefl_config', JSON.stringify(config));
    
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('infoScreen').classList.remove('hidden');
}

function showSetupScreen() {
    document.getElementById('infoScreen').classList.add('hidden');
    document.getElementById('setupScreen').classList.remove('hidden');
    
    document.getElementById('apiKeyInput').value = config.apiKey || '';
    document.getElementById('sheetsUrlInput').value = config.sheetsUrl || '';
}

function startCapture() {
    const name = document.getElementById('studentName').value.trim();
    const classVal = document.getElementById('studentClass').value.trim();
    const phone = document.getElementById('parentPhone').value.trim();
    
    if (!name || !classVal || !phone) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin h·ªçc sinh!');
        return;
    }
    
    studentInfo = { name, class: classVal, parentPhone: phone };
    
    document.getElementById('infoScreen').classList.add('hidden');
    document.getElementById('cameraScreen').classList.remove('hidden');
    
    startCamera();
}

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 4096 },
                height: { ideal: 2160 },
                aspectRatio: 16/9
            } 
        });
        document.getElementById('video').srcObject = stream;
    } catch (error) {
        alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + error.message);
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
}

function capturePhoto() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    capturedImageData = canvas.toDataURL('image/jpeg', 1.0);
    
    stopCamera();
    
    document.getElementById('cameraScreen').classList.add('hidden');
    document.getElementById('previewScreen').classList.remove('hidden');
    document.getElementById('previewImage').src = capturedImageData;
}

function backToInfo() {
    stopCamera();
    document.getElementById('cameraScreen').classList.add('hidden');
    document.getElementById('infoScreen').classList.remove('hidden');
}

function retakePhoto() {
    document.getElementById('previewScreen').classList.add('hidden');
    document.getElementById('cameraScreen').classList.remove('hidden');
    startCamera();
}

async function processAnswerSheet() {
    document.getElementById('processBtn').disabled = true;
    document.getElementById('retakeBtn').disabled = true;
    document.getElementById('processingStatus').classList.remove('hidden');
    
    updateStatus('ƒêang g·ª≠i ·∫£nh ƒë·∫øn AI...');
    
    try {
        const base64Data = capturedImageData.split(',')[1];
        
        updateStatus('AI ƒëang ph√¢n t√≠ch phi·∫øu tr·∫£ l·ªùi...');
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${config.apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        {
                            inline_data: {
                                mime_type: 'image/jpeg',
                                data: base64Data
                            }
                        },
                        {
                            text: `ƒê√¢y l√† phi·∫øu tr·∫£ l·ªùi TOEFL Primary Step 2.

Phi·∫øu c√≥ 2 ph·∫ßn:
- READING: c√¢u 1-39 (c·ªôt b√™n tr√°i, header m√†u xanh l√°)
- LISTENING: c√¢u 1-41 (c·ªôt b√™n ph·∫£i, header m√†u h·ªìng)

Nhi·ªám v·ª•: ƒê·ªçc c√°c √¥ tr√≤n ƒë√£ ƒë∆∞·ª£c t√¥ ƒëen/ƒë·∫≠m v√† tr·∫£ v·ªÅ JSON v·ªõi format:

{
  "reading": {
    "1": "A",
    "2": "B",
    ...
  },
  "listening": {
    "1": "C",
    "2": "A",
    ...
  }
}

CH·ªà TR·∫¢ V·ªÄ JSON, KH√îNG GI·∫¢I TH√çCH G√å TH√äM. N·∫øu c√¢u n√†o kh√¥ng t√¥ ho·∫∑c kh√¥ng r√µ th√¨ b·ªè qua c√¢u ƒë√≥.`
                        }
                    ]
                }]
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error('API request failed: ' + (errorData.error?.message || response.status));
        }
        
        const data = await response.json();
        const aiResponse = data.candidates[0].content.parts[0].text;
        
        updateStatus('ƒêang x·ª≠ l√Ω k·∫øt qu·∫£...');
        
        const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
            throw new Error('Kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c phi·∫øu tr·∫£ l·ªùi. Vui l√≤ng ch·ª•p l·∫°i ·∫£nh r√µ h∆°n.');
        }
        
        const studentAnswers = JSON.parse(jsonMatch[0]);
        
        const results = calculateScores(studentAnswers);
        
        updateStatus('ƒêang g·ª≠i k·∫øt qu·∫£ l√™n Google Sheets...');
        
        await sendToGoogleSheets(results);
        
        displayResults(results);
        
    } catch (error) {
        alert('L·ªói: ' + error.message);
        document.getElementById('processBtn').disabled = false;
        document.getElementById('retakeBtn').disabled = false;
        document.getElementById('processingStatus').classList.add('hidden');
    }
}

function updateStatus(text) {
    document.getElementById('statusText').textContent = text;
}

function calculateScores(studentAnswers) {
    const results = {
        student: studentInfo,
        timestamp: new Date().toLocaleString('vi-VN'),
        reading: analyzeSection('reading', studentAnswers.reading || {}),
        listening: analyzeSection('listening', studentAnswers.listening || {})
    };
    
    return results;
}

function analyzeSection(section, answers) {
    const correctAnswers = CORRECT_ANSWERS[section];
    const skills = SKILL_CATEGORIES[section];
    
    let correctCount = 0;
    let totalQuestions = Object.keys(correctAnswers).length;
    const wrongQuestions = [];
    
    for (const [qNum, correctAns] of Object.entries(correctAnswers)) {
        if (answers[qNum] === correctAns) {
            correctCount++;
        } else if (answers[qNum]) {
            wrongQuestions.push(qNum);
        }
    }
    
    const totalScore = Math.round((correctCount / totalQuestions) * 100);
    
    const skillScores = {};
    for (const [skillName, skillData] of Object.entries(skills)) {
        let skillCorrect = 0;
        skillData.questions.forEach(qNum => {
            if (answers[qNum] === correctAnswers[qNum]) {
                skillCorrect++;
            }
        });
        skillScores[skillName] = {
            correct: skillCorrect,
            total: skillData.questions.length,
            percentage: Math.round((skillCorrect / skillData.questions.length) * 100),
            name: skillData.name,
            level: skillData.level
        };
    }
    
    const cefrLevel = estimateCEFRLevel(totalScore, skillScores, section);
    const overallAssessment = generateOverallAssessment(totalScore, cefrLevel, section);
    const skillAnalysis = section === 'reading' ? analyzeReadingSkills(skillScores) : analyzeListeningSkills(skillScores);
    const strengthsDetail = generateDetailedStrengths(skillScores, skills);
    const weaknessesDetail = generateDetailedWeaknesses(skillScores, skills);
    const recommendationsDetail = generateDetailedRecommendations(totalScore, skillScores, cefrLevel, section);
    
    return {
        answers,
        correctCount,
        totalQuestions,
        totalScore,
        wrongQuestions,
        skillScores,
        cefrLevel,
        overallAssessment,
        skillAnalysis,
        strengthsDetail,
        weaknessesDetail,
        recommendationsDetail
    };
}

function estimateCEFRLevel(score, skills, section) {
    if (section === 'reading') {
        const vocab = skills.vocabulary.percentage;
        const inference = skills.inference.percentage;
        const details = skills.details.percentage;
        
        if (score >= 90 && vocab >= 85 && inference >= 85) return 'B1 - Cu·ªëi (Upper B1)';
        if (score >= 80 && vocab >= 75) return 'B1 - Gi·ªØa (Mid B1)';
        if (score >= 70 && inference >= 60) return 'B1 - ƒê·∫ßu (Lower B1)';
        if (score >= 60 && details >= 65) return 'A2 - Cu·ªëi (Upper A2)';
        if (score >= 50) return 'A2 - Gi·ªØa (Mid A2)';
        if (score >= 40) return 'A2 - ƒê·∫ßu (Lower A2)';
        if (score >= 30) return 'A1 - Cu·ªëi (Upper A1)';
        if (score >= 20) return 'A1 - Gi·ªØa (Mid A1)';
        return 'A1 - ƒê·∫ßu (Lower A1)';
    } else {
        const basic = skills.basicComprehension.percentage;
        const inference = skills.inference.percentage;
        const details = skills.details.percentage;
        
        if (score >= 90 && basic >= 85 && inference >= 85) return 'B1 - Cu·ªëi (Upper B1)';
        if (score >= 80 && inference >= 70) return 'B1 - Gi·ªØa (Mid B1)';
        if (score >= 70 && inference >= 60) return 'B1 - ƒê·∫ßu (Lower B1)';
        if (score >= 60 && details >= 65) return 'A2 - Cu·ªëi (Upper A2)';
        if (score >= 50) return 'A2 - Gi·ªØa (Mid A2)';
        if (score >= 40) return 'A2 - ƒê·∫ßu (Lower A2)';
        if (score >= 30) return 'A1 - Cu·ªëi (Upper A1)';
        if (score >= 20) return 'A1 - Gi·ªØa (Mid A1)';
        return 'A1 - ƒê·∫ßu (Lower A1)';
    }
}

function generateOverallAssessment(score, cefrLevel, section) {
    let assessment = `H·ªçc sinh ƒë·∫°t ${score}% (${cefrLevel}). `;
    
    const skillType = section === 'reading' ? 'ƒë·ªçc' : 'nghe';
    
    if (score >= 80) {
        assessment += `K·ªπ nƒÉng ${skillType} ti·∫øng Anh r·∫•t t·ªët, c√≥ th·ªÉ hi·ªÉu ${section === 'reading' ? 'v√† ph√¢n t√≠ch c√°c b√†i ƒë·ªçc ph·ª©c t·∫°p' : 'h·ªôi tho·∫°i v√† c√¢u chuy·ªán ph·ª©c t·∫°p'}. `;
    } else if (score >= 60) {
        assessment += `K·ªπ nƒÉng ${skillType} ti·∫øng Anh kh√°, c√≥ th·ªÉ hi·ªÉu n·ªôi dung ch√≠nh v√† m·ªôt s·ªë chi ti·∫øt${section === 'reading' ? '' : ' quan tr·ªçng'}. `;
    } else if (score >= 40) {
        assessment += `K·ªπ nƒÉng ${skillType} ti·∫øng Anh c∆° b·∫£n, c·∫ßn c·∫£i thi·ªán th√™m ƒë·ªÉ n·∫Øm v·ªØng c√°c k·ªπ nƒÉng ${skillType} hi·ªÉu. `;
    } else {
        assessment += `K·ªπ nƒÉng ${skillType} ti·∫øng Anh c√≤n y·∫øu, c·∫ßn t·∫≠p trung ${section === 'reading' ? 'h·ªçc t·ª´ v·ª±ng v√† k·ªπ nƒÉng ƒë·ªçc hi·ªÉu' : 'luy·ªán nghe t·ª´ v·ª±ng v√† c√¢u ƒë∆°n gi·∫£n h√†ng ng√†y'}. `;
    }
    
    return assessment;
}

function analyzeReadingSkills(skills) {
    let analysis = 'K·ªπ nƒÉng ƒë·ªçc hi·ªÉu: ';
    const strengths = [];
    const weaknesses = [];
    
    if (skills.vocabulary.percentage >= 75) {
        strengths.push('t·ª´ v·ª±ng t·ªët');
    } else if (skills.vocabulary.percentage < 60) {
        weaknesses.push('t·ª´ v·ª±ng (c·∫ßn h·ªçc th√™m t·ª´ A2-B1)');
    }
    
    if (skills.details.percentage >= 75) {
        strengths.push('t√¨m chi ti·∫øt');
    } else if (skills.details.percentage < 60) {
        weaknesses.push('t√¨m chi ti·∫øt (c·∫ßn ƒë·ªçc k·ªπ t·ª´ng c√¢u)');
    }
    
    if (skills.mainIdea.percentage >= 75) {
        strengths.push('x√°c ƒë·ªãnh √Ω ch√≠nh');
    } else if (skills.mainIdea.percentage < 60) {
        weaknesses.push('x√°c ƒë·ªãnh √Ω ch√≠nh (c·∫ßn luy·ªán t√≥m t·∫Øt ƒëo·∫°n vƒÉn)');
    }
    
    if (skills.inference.percentage >= 75) {
        strengths.push('suy lu·∫≠n');
    } else if (skills.inference.percentage < 60) {
        weaknesses.push('suy lu·∫≠n ·∫©n √Ω (c·∫ßn ƒë·ªçc gi·ªØa c√°c d√≤ng)');
    }
    
    if (skills.sequence.percentage >= 75) {
        strengths.push('hi·ªÉu tr√¨nh t·ª±');
    } else if (skills.sequence.percentage < 60) {
        weaknesses.push('hi·ªÉu tr√¨nh t·ª± h∆∞·ªõng d·∫´n (c·∫ßn luy·ªán ƒë·ªçc instructions)');
    }
    
    if (strengths.length > 0) {
        analysis += `ƒêi·ªÉm m·∫°nh: ${strengths.join(', ')}. `;
    }
    
    if (weaknesses.length > 0) {
        analysis += `C·∫ßn c·∫£i thi·ªán: ${weaknesses.join(', ')}. `;
    } else {
        analysis += 'T·∫•t c·∫£ c√°c k·ªπ nƒÉng ƒë·ªçc ƒë·ªÅu t·ªët. ';
    }
    
    return analysis;
}

function analyzeListeningSkills(skills) {
    let analysis = 'K·ªπ nƒÉng nghe: ';
    const strengths = [];
    const weaknesses = [];
    
    if (skills.basicComprehension.percentage >= 75) {
        strengths.push('hi·ªÉu c∆° b·∫£n');
    } else if (skills.basicComprehension.percentage < 60) {
        weaknesses.push('hi·ªÉu c√¢u ƒë∆°n gi·∫£n (c·∫ßn luy·ªán nghe t·ª´ v·ª±ng c∆° b·∫£n)');
    }
    
    if (skills.details.percentage >= 75) {
        strengths.push('nghe chi ti·∫øt');
    } else if (skills.details.percentage < 60) {
        weaknesses.push('nghe chi ti·∫øt (c·∫ßn ch√∫ √Ω t·ª´ kh√≥a)');
    }
    
    if (skills.mainIdea.percentage >= 75) {
        strengths.push('x√°c ƒë·ªãnh √Ω ch√≠nh');
    } else if (skills.mainIdea.percentage < 60) {
        weaknesses.push('x√°c ƒë·ªãnh √Ω ch√≠nh (c·∫ßn t·∫≠p t√≥m t·∫Øt n·ªôi dung)');
    }
    
    if (skills.inference.percentage >= 75) {
        strengths.push('suy lu·∫≠n');
    } else if (skills.inference.percentage < 60) {
        weaknesses.push('suy lu·∫≠n ·∫©n √Ω (c·∫ßn luy·ªán ƒëo√°n nghƒ©a)');
    }
    
    if (skills.purpose.percentage >= 75) {
        strengths.push('hi·ªÉu m·ª•c ƒë√≠ch');
    } else if (skills.purpose.percentage < 60) {
        weaknesses.push('hi·ªÉu m·ª•c ƒë√≠ch giao ti·∫øp (c·∫ßn luy·ªán function language)');
    }
    
    if (strengths.length > 0) {
        analysis += `ƒêi·ªÉm m·∫°nh: ${strengths.join(', ')}. `;
    }
    
    if (weaknesses.length > 0) {
        analysis += `C·∫ßn c·∫£i thi·ªán: ${weaknesses.join(', ')}. `;
    } else {
        analysis += 'T·∫•t c·∫£ c√°c k·ªπ nƒÉng nghe ƒë·ªÅu t·ªët. ';
    }
    
    return analysis;
}

function generateDetailedStrengths(skills, skillCategories) {
    const strengths = [];
    
    for (const [skill, data] of Object.entries(skills)) {
        if (data.percentage >= 75) {
            strengths.push(`${data.name} (${data.percentage}%)`);
        }
    }
    
    if (strengths.length === 0) {
        return 'C·∫ßn c·ªë g·∫Øng th√™m ƒë·ªÉ ph√°t tri·ªÉn ƒëi·ªÉm m·∫°nh';
    }
    
    return strengths.join(', ');
}

function generateDetailedWeaknesses(skills, skillCategories) {
    const weaknesses = [];
    
    for (const [skill, data] of Object.entries(skills)) {
        if (data.percentage < 60) {
            weaknesses.push(`${data.name} (${data.percentage}%) - Tr√¨nh ƒë·ªô ${data.level}`);
        }
    }
    
    if (weaknesses.length === 0) {
        return 'Kh√¥ng c√≥ ƒëi·ªÉm y·∫øu ƒë√°ng k·ªÉ';
    }
    
    return weaknesses.join(' | ');
}

function generateDetailedRecommendations(score, skills, cefrLevel, section) {
    let recommendations = '';
    
    if (section === 'reading') {
        if (skills.vocabulary.percentage < 60) {
            recommendations += 'üìö T·ª™ V·ª∞NG: (1) H·ªçc 10-15 t·ª´ m·ªõi m·ªói ng√†y qua Quizlet ho·∫∑c Anki; (2) ƒê·ªçc s√°ch truy·ªán tranh ti·∫øng Anh tr√¨nh ƒë·ªô A1-A2; (3) Xem phim ho·∫°t h√¨nh c√≥ ph·ª• ƒë·ªÅ ti·∫øng Anh. ';
        }
        
        if (skills.details.percentage < 60) {
            recommendations += 'üîç CHI TI·∫æT: (1) Luy·ªán scanning (qu√©t t√¨m th√¥ng tin c·ª• th·ªÉ); (2) ƒê·ªçc l·∫°i c√¢u h·ªèi 2 l·∫ßn tr∆∞·ªõc khi t√¨m ƒë√°p √°n; (3) G·∫°ch ch√¢n keywords trong c√¢u h·ªèi. ';
        }
        
        if (skills.mainIdea.percentage < 60) {
            recommendations += 'üí° √ù CH√çNH: (1) ƒê·ªçc c√¢u ƒë·∫ßu v√† c√¢u cu·ªëi m·ªói ƒëo·∫°n; (2) Luy·ªán t√≥m t·∫Øt ƒëo·∫°n vƒÉn b·∫±ng 1 c√¢u; (3) T√¨m t·ª´ kh√≥a l·∫∑p l·∫°i nhi·ªÅu l·∫ßn trong b√†i. ';
        }
        
        if (skills.inference.percentage < 60) {
            recommendations += 'üß† SUY LU·∫¨N: (1) H·ªçc c√°ch "ƒë·ªçc gi·ªØa c√°c d√≤ng"; (2) Suy nghƒ© "t√°c gi·∫£ mu·ªën n√≥i g√¨?"; (3) Luy·ªán ƒë·ªçc c√°c b√†i c√≥ inference questions. ';
        }
        
        if (skills.sequence.percentage < 60) {
            recommendations += 'üìã TR√åNH T·ª∞: (1) Luy·ªán ƒë·ªçc instructions (c√¥ng th·ª©c n·∫•u ƒÉn, h∆∞·ªõng d·∫´n l√†m ƒë·ªì th·ªß c√¥ng); (2) Ch√∫ √Ω c√°c t·ª´: first, then, next, finally; (3) V·∫Ω s∆° ƒë·ªì c√°c b∆∞·ªõc khi ƒë·ªçc. ';
        }
        
        if (cefrLevel.includes('A1')) {
            recommendations += '\nüéØ M·ª§C TI√äU: ƒê·ªÉ ƒë·∫°t A2, c·∫ßn: (1) N·∫Øm 500-1000 t·ª´ v·ª±ng c∆° b·∫£n; (2) ƒê·ªçc ƒë∆∞·ª£c b√†i ng·∫Øn 100-150 t·ª´; (3) Hi·ªÉu √Ω ch√≠nh v√† chi ti·∫øt ƒë∆°n gi·∫£n. ';
        } else if (cefrLevel.includes('A2')) {
            recommendations += '\nüéØ M·ª§C TI√äU: ƒê·ªÉ ƒë·∫°t B1, c·∫ßn: (1) N·∫Øm 1500-2000 t·ª´ v·ª±ng; (2) ƒê·ªçc ƒë∆∞·ª£c b√†i 200-300 t·ª´; (3) Hi·ªÉu ƒë∆∞·ª£c ·∫©n √Ω v√† suy lu·∫≠n. ';
        } else if (cefrLevel.includes('B1')) {
            recommendations += '\nüéØ M·ª§C TI√äU: Duy tr√¨ v√† n√¢ng cao B1, c·∫ßn: (1) ƒê·ªçc s√°ch, b√°o ti·∫øng Anh th∆∞·ªùng xuy√™n; (2) H·ªçc t·ª´ v·ª±ng academic; (3) Luy·ªán IELTS Reading ho·∫∑c TOEFL Junior. ';
        }
        
        recommendations += '\nüìñ T√ÄI LI·ªÜU ƒê·ªÄ XU·∫§T: ';
        if (score < 50) {
            recommendations += 'Oxford Read and Discover Level 1-2, Cambridge Storybooks Level 1-2, Reading Explorer Foundations. ';
        } else if (score < 70) {
            recommendations += 'Oxford Read and Discover Level 3-4, Cambridge Storybooks Level 3-4, Reading Explorer 1. ';
        } else {
            recommendations += 'Oxford Read and Discover Level 5-6, Cambridge Storybooks Level 5-6, Reading Explorer 2. ';
        }
    } else {
        // LISTENING
        if (skills.basicComprehension.percentage < 60) {
            recommendations += 'üéß HI·ªÇU C∆† B·∫¢N: (1) Nghe 15-20 ph√∫t m·ªói ng√†y v·ªõi audio ƒë∆°n gi·∫£n; (2) Xem phim ho·∫°t h√¨nh c√≥ ph·ª• ƒë·ªÅ ti·∫øng Anh; (3) Luy·ªán dictation (nghe vi·∫øt) c√¢u ng·∫Øn. ';
        }
        
        if (skills.details.percentage < 60) {
            recommendations += 'üîç CHI TI·∫æT: (1) T·∫≠p trung nghe t·ª´ kh√≥a (who, what, when, where); (2) ƒê·ªçc c√¢u h·ªèi tr∆∞·ªõc khi nghe; (3) Ghi ch√∫ nhanh th√¥ng tin quan tr·ªçng. ';
        }
        
        if (skills.mainIdea.percentage < 60) {
            recommendations += 'üí° √ù CH√çNH: (1) Ch√∫ √Ω c√¢u ƒë·∫ßu v√† c√¢u cu·ªëi; (2) Luy·ªán t√≥m t·∫Øt ƒëo·∫°n nghe b·∫±ng 1 c√¢u; (3) T√¨m √Ω ƒë∆∞·ª£c l·∫∑p l·∫°i nhi·ªÅu l·∫ßn. ';
        }
        
        if (skills.inference.percentage < 60) {
            recommendations += 'üß† SUY LU·∫¨N: (1) H·ªçc c√°ch "nghe gi·ªØa c√°c d√≤ng"; (2) Ch√∫ √Ω ng·ªØ ƒëi·ªáu v√† c·∫£m x√∫c ng∆∞·ªùi n√≥i; (3) Luy·ªán ƒëo√°n nghƒ©a t·ª´ ng·ªØ c·∫£nh. ';
        }
        
        if (skills.purpose.percentage < 60) {
            recommendations += 'üéØ M·ª§C ƒê√çCH: (1) H·ªçc function language (m·ªùi, t·ª´ ch·ªëi, g·ª£i √Ω); (2) Ch√∫ √Ω c·∫•u tr√∫c "Why did...?" "What...for?"; (3) Luy·ªán v·ªõi phone messages v√† conversations. ';
        }
        
        if (cefrLevel.includes('A1')) {
            recommendations += '\nüéØ M·ª§C TI√äU: ƒê·ªÉ ƒë·∫°t A2, c·∫ßn: (1) Nghe hi·ªÉu 300-500 t·ª´ v·ª±ng h√†ng ng√†y; (2) Hi·ªÉu h·ªôi tho·∫°i ng·∫Øn 1-2 ph√∫t; (3) N·∫Øm ƒë∆∞·ª£c √Ω ch√≠nh v√† chi ti·∫øt ƒë∆°n gi·∫£n. ';
        } else if (cefrLevel.includes('A2')) {
            recommendations += '\nüéØ M·ª§C TI√äU: ƒê·ªÉ ƒë·∫°t B1, c·∫ßn: (1) Nghe hi·ªÉu 1000-1500 t·ª´ v·ª±ng; (2) Hi·ªÉu audio 3-5 ph√∫t; (3) Suy lu·∫≠n ƒë∆∞·ª£c ·∫©n √Ω v√† th√°i ƒë·ªô ng∆∞·ªùi n√≥i. ';
        } else if (cefrLevel.includes('B1')) {
            recommendations += '\nüéØ M·ª§C TI√äU: Duy tr√¨ v√† n√¢ng cao B1, c·∫ßn: (1) Nghe podcast, audiobook ti·∫øng Anh; (2) H·ªçc t·ª´ v·ª±ng academic v√† idioms; (3) Luy·ªán IELTS Listening ho·∫∑c TOEFL Junior. ';
        }
        
        recommendations += '\nüìñ T√ÄI LI·ªÜU ƒê·ªÄ XU·∫§T: ';
        if (score < 50) {
            recommendations += 'British Council LearnEnglish Kids, ESL Pod (Beginner), Simple English Videos, Peppa Pig (with subtitles). ';
        } else if (score < 70) {
            recommendations += 'BBC Learning English (6 Minute English), ESL Pod (Intermediate), TED-Ed, VOA Learning English. ';
        } else {
            recommendations += 'TED Talks, Podcasts (This American Life), BBC Radio, National Geographic documentaries. ';
        }
        
        recommendations += '\nüí™ LUY·ªÜN T·∫¨P H√ÄNG NG√ÄY: (1) Nghe 20-30 ph√∫t m·ªói ng√†y; (2) Shadow (l·∫∑p l·∫°i ngay sau ng∆∞·ªùi n√≥i); (3) Dictation 5 c√¢u m·ªói ng√†y; (4) Xem phim c√≥ ph·ª• ƒë·ªÅ ti·∫øng Anh.';
    }
    
    return recommendations.trim();
}

async function sendToGoogleSheets(results) {
    const data = {
        timestamp: results.timestamp,
        name: results.student.name,
        class: results.student.class,
        parentPhone: results.student.parentPhone,
        
        // Reading data
        readingScore: results.reading.totalScore,
        readingCorrect: results.reading.correctCount,
        readingTotal: results.reading.totalQuestions,
        readingCEFR: results.reading.cefrLevel,
        readingWrongQuestions: results.reading.wrongQuestions.join(', ') || 'Kh√¥ng c√≥',
        readingOverallAssessment: results.reading.overallAssessment,
        readingSkillAnalysis: results.reading.skillAnalysis,
        readingStrengthsDetail: results.reading.strengthsDetail,
        readingWeaknessesDetail: results.reading.weaknessesDetail,
        readingRecommendations: results.reading.recommendationsDetail,
        readingVocabulary: results.reading.skillScores.vocabulary?.percentage || 0,
        readingMainIdea: results.reading.skillScores.mainIdea?.percentage || 0,
        readingDetails: results.reading.skillScores.details?.percentage || 0,
        readingInference: results.reading.skillScores.inference?.percentage || 0,
        readingSequence: results.reading.skillScores.sequence?.percentage || 0,
        readingPurpose: results.reading.skillScores.purpose?.percentage || 0,
        
        // Listening data
        listeningScore: results.listening.totalScore,
        listeningCorrect: results.listening.correctCount,
        listeningTotal: results.listening.totalQuestions,
        listeningCEFR: results.listening.cefrLevel,
        listeningWrongQuestions: results.listening.wrongQuestions.join(', ') || 'Kh√¥ng c√≥',
        listeningOverallAssessment: results.listening.overallAssessment,
        listeningSkillAnalysis: results.listening.skillAnalysis,
        listeningStrengthsDetail: results.listening.strengthsDetail,
        listeningWeaknessesDetail: results.listening.weaknessesDetail,
        listeningRecommendations: results.listening.recommendationsDetail,
        listeningBasic: results.listening.skillScores.basicComprehension?.percentage || 0,
        listeningMainIdea: results.listening.skillScores.mainIdea?.percentage || 0,
        listeningDetails: results.listening.skillScores.details?.percentage || 0,
        listeningInference: results.listening.skillScores.inference?.percentage || 0,
        listeningPurpose: results.listening.skillScores.purpose?.percentage || 0,
        
        // Overall
        overallScore: Math.round((results.reading.totalScore + results.listening.totalScore) / 2),
        
        // Raw answers
        readingAnswers: JSON.stringify(results.reading.answers),
        listeningAnswers: JSON.stringify(results.listening.answers)
    };
    
    try {
        await fetch(config.sheetsUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
    } catch (error) {
        console.error('L·ªói khi g·ª≠i Google Sheets:', error);
    }
}

function displayResults(results) {
    document.getElementById('previewScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');
    
    const html = `
        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 mb-6 border-2 border-purple-200">
            <h2 class="text-2xl font-bold text-purple-700 mb-4">üìã Th√¥ng Tin H·ªçc Sinh</h2>
            <div class="grid grid-cols-2 gap-4 text-lg">
                <div><strong>H·ªç t√™n:</strong> ${results.student.name}</div>
                <div><strong>L·ªõp:</strong> ${results.student.class}</div>
                <div><strong>SƒêT ph·ª• huynh:</strong> ${results.student.parentPhone}</div>
                <div><strong>Th·ªùi gian:</strong> ${results.timestamp}</div>
            </div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- READING RESULTS -->
            <div class="bg-green-50 rounded-xl p-6 border-2 border-green-300">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-green-600 text-white rounded-full flex items-center justify-center text-2xl font-bold">
                        R
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-green-800">READING</h3>
                        <p class="text-green-600 text-sm">K·ªπ nƒÉng ƒë·ªçc</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4 mb-4">
                    <div class="text-center">
                        <div class="text-5xl font-bold text-green-600 mb-2">${results.reading.totalScore}%</div>
                        <div class="text-lg font-semibold text-green-700">${results.reading.cefrLevel}</div>
                        <div class="text-sm text-gray-600 mt-2">
                            ${results.reading.correctCount}/${results.reading.totalQuestions} c√¢u ƒë√∫ng
                        </div>
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    ${Object.entries(results.reading.skillScores).map(([key, skill]) => `
                        <div class="bg-white rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-semibold text-gray-700">${skill.name}</span>
                                <span class="text-sm font-bold ${skill.percentage >= 75 ? 'text-green-600' : skill.percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${skill.percentage}%
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full ${skill.percentage >= 75 ? 'bg-green-500' : skill.percentage >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                     style="width: ${skill.percentage}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${skill.correct}/${skill.total} c√¢u ‚Ä¢ Level ${skill.level}</div>
                        </div>
                    `).join('')}
                </div>
                
                ${results.reading.wrongQuestions.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <p class="text-sm font-semibold text-red-700 mb-1">‚ùå C√¢u sai:</p>
                        <p class="text-sm text-red-600">${results.reading.wrongQuestions.join(', ')}</p>
                    </div>
                ` : ''}
            </div>
            
            <!-- LISTENING RESULTS -->
            <div class="bg-blue-50 rounded-xl p-6 border-2 border-blue-300">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl font-bold">
                        L
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-blue-800">LISTENING</h3>
                        <p class="text-blue-600 text-sm">K·ªπ nƒÉng nghe</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4 mb-4">
                    <div class="text-center">
                        <div class="text-5xl font-bold text-blue-600 mb-2">${results.listening.totalScore}%</div>
                        <div class="text-lg font-semibold text-blue-700">${results.listening.cefrLevel}</div>
                        <div class="text-sm text-gray-600 mt-2">
                            ${results.listening.correctCount}/${results.listening.totalQuestions} c√¢u ƒë√∫ng
                        </div>
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    ${Object.entries(results.listening.skillScores).map(([key, skill]) => `
                        <div class="bg-white rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-semibold text-gray-700">${skill.name}</span>
                                <span class="text-sm font-bold ${skill.percentage >= 75 ? 'text-green-600' : skill.percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${skill.percentage}%
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full ${skill.percentage >= 75 ? 'bg-green-500' : skill.percentage >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                     style="width: ${skill.percentage}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${skill.correct}/${skill.total} c√¢u ‚Ä¢ Level ${skill.level}</div>
                        </div>
                    `).join('')}
                </div>
                
                ${results.listening.wrongQuestions.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <p class="text-sm font-semibold text-red-700 mb-1">‚ùå C√¢u sai:</p>
                        <p class="text-sm text-red-600">${results.listening.wrongQuestions.join(', ')}</p>
                    </div>
                ` : ''}
            </div>
        </div>
        
        <!-- OVERALL ANALYSIS -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border-2 border-purple-300 mb-6">
            <h3 class="text-xl font-bold text-purple-700 mb-4">üìä Ph√¢n T√≠ch T·ªïng Quan</h3>
            
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div class="bg-white rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">ƒêi·ªÉm trung b√¨nh</p>
                    <p class="text-3xl font-bold text-purple-600">
                        ${Math.round((results.reading.totalScore + results.listening.totalScore) / 2)}%
                    </p>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">CEFR Level d·ª± ki·∫øn</p>
                    <p class="text-2xl font-bold text-purple-600">
                        ${getBestCEFR(results.reading.cefrLevel, results.listening.cefrLevel)}
                    </p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 space-y-3">
                <div>
                    <p class="font-semibold text-green-700 mb-2">‚úÖ Reading - ƒê√°nh gi√°:</p>
                    <p class="text-sm text-gray-700 mb-2">${results.reading.overallAssessment}</p>
                    <p class="text-sm text-gray-700">${results.reading.skillAnalysis}</p>
                </div>
                <div>
                    <p class="font-semibold text-blue-700 mb-2">‚úÖ Listening - ƒê√°nh gi√°:</p>
                    <p class="text-sm text-gray-700 mb-2">${results.listening.overallAssessment}</p>
                    <p class="text-sm text-gray-700">${results.listening.skillAnalysis}</p>
                </div>
            </div>
        </div>
        
        <!-- DETAILED STRENGTHS & WEAKNESSES -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- READING DETAILS -->
            <div class="bg-white rounded-xl p-6 border-2 border-green-200">
                <h3 class="text-lg font-bold text-green-700 mb-4">üìñ Reading - Chi ti·∫øt</h3>
                
                <div class="mb-4">
                    <p class="font-semibold text-green-600 mb-2">üí™ ƒêi·ªÉm m·∫°nh:</p>
                    <p class="text-sm text-gray-700">${results.reading.strengthsDetail}</p>
                </div>
                
                <div class="mb-4">
                    <p class="font-semibold text-orange-600 mb-2">‚ö†Ô∏è ƒêi·ªÉm y·∫øu:</p>
                    <p class="text-sm text-gray-700">${results.reading.weaknessesDetail}</p>
                </div>
                
                <div>
                    <p class="font-semibold text-purple-600 mb-2">üìö G·ª£i √Ω c·∫£i thi·ªán:</p>
                    <p class="text-sm text-gray-700 whitespace-pre-line">${results.reading.recommendationsDetail}</p>
                </div>
            </div>
            
            <!-- LISTENING DETAILS -->
            <div class="bg-white rounded-xl p-6 border-2 border-blue-200">
                <h3 class="text-lg font-bold text-blue-700 mb-4">üéß Listening - Chi ti·∫øt</h3>
                
                <div class="mb-4">
                    <p class="font-semibold text-green-600 mb-2">üí™ ƒêi·ªÉm m·∫°nh:</p>
                    <p class="text-sm text-gray-700">${results.listening.strengthsDetail}</p>
                </div>
                
                <div class="mb-4">
                    <p class="font-semibold text-orange-600 mb-2">‚ö†Ô∏è ƒêi·ªÉm y·∫øu:</p>
                    <p class="text-sm text-gray-700">${results.listening.weaknessesDetail}</p>
                </div>
                
                <div>
                    <p class="font-semibold text-purple-600 mb-2">üìö G·ª£i √Ω c·∫£i thi·ªán:</p>
                    <p class="text-sm text-gray-700 whitespace-pre-line">${results.listening.recommendationsDetail}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="font-bold text-yellow-800 mb-2">üìû Li√™n h·ªá ph·ª• huynh:</h3>
                    <p class="text-yellow-700 text-sm">
                        K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng. Gi√°o vi√™n s·∫Ω li√™n h·ªá ph·ª• huynh qua s·ªë 
                        <strong>${results.student.parentPhone}</strong> ƒë·ªÉ t∆∞ v·∫•n chi ti·∫øt v·ªÅ k·∫øt qu·∫£ v√† l·ªô tr√¨nh h·ªçc t·∫≠p.
                    </p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('resultContent').innerHTML = html;
}

function getBestCEFR(reading, listening) {
    const levels = ['A1', 'A2 - ƒê·∫ßu', 'A2 - Gi·ªØa', 'A2 - Cu·ªëi', 'B1 - ƒê·∫ßu', 'B1 - Gi·ªØa', 'B1 - Cu·ªëi'];
    const r = levels.findIndex(l => reading.includes(l.split(' ')[0]));
    const l = levels.findIndex(l => listening.includes(l.split(' ')[0]));
    return levels[Math.floor((r + l) / 2)] || 'A2';
}

function resetSystem() {
    document.getElementById('resultScreen').classList.add('hidden');
    document.getElementById('infoScreen').classList.remove('hidden');
    
    document.getElementById('studentName').value = '';
    document.getElementById('studentClass').value = '';
    document.getElementById('parentPhone').value = '';
    
    capturedImageData = null;
    studentInfo = {};
}

loadConfig();
</script>

</body>
</html>